# 设计篇

在建设一个网站时，其最初的设计往往会对整个系统起到至关重要的影响。因此，在众多不同方面之中，我们先来讨论下系统的一些设计规则，

本篇内容概括如下：

1. 避免复杂的方案和过度设计
2. 尽量使用统一的技术和框架
3. 系统需要具备垂直伸缩及水平伸缩的能力
4. 努力消除系统中的单点
5. 为系统中的热点降温
6. 保证操作的幂等性
7. 系统间的交互尽量采用异步方式

## Rule 1. 避免复杂的方案和过度设计

### 目的描述

避免出现过于复杂的系统设计和实现，尤其是看似超前的过度设计。

### 实践要点

任何系统中都应尽量避免复杂的设计，尤其是过度设计，不仅增加了工作量，还提升了开发和运维的难度，却没有带来相应的好处。

> 做的复杂不难，做的简单才难

在满足系统今后一段时间内的可扩展性和稳定性要求的同事，尽力那个避免复杂的架构和局部实现，以简单的方式直接实现需求。一个难以理解的方案，同样会难于实现和运维。

此外，不要为了虚无缥缈的目标进行设计，例如，原本要求为一家中型公司设计CRM和ERP，但是在具体设计方案时却按照2000万用户的级别来设计，这已经和上海市的人口在一个数量级上了，显然远远超出了实际需求。

在完成概要设计后，再找几位没有参与设计的同学，向他们叙述方案，如果对方不能很快理解设计方案，说明该方案过于复杂。如果设计的方案能够支持未来5-10年的需求，那也许可以考虑在实现上加以简化。

### 案例说明

## Rule 2. 尽量使用统一的技术和框架

### 目的描述

在同一个公司内，如非必要，尽量采用统一的技术和框架，避免出现技术繁杂的情况，过多的异构系统会带来一定的运维成本，不同系统的运维方式不同，配置也不尽相同，突然引入的新技术可能对现有体系带来一定的冲击。

### 实践要点

在现有体系中如果需要新建系统，在技术选型时，可以考虑采用与现有系统相近的技术和框架；如果公司有成熟的内部框架，更应该首先考虑使用内部框架，原因是内部框架一般都会更加符合公司的情况，且遇到问题时能够得到更快速的响应。不要出于个人喜好选择不同，甚至是另类的框架和技术，比如在一家以Java为主的公司里，在生产系统中使用Lisp就比较另类，尤其是在处理能用Java解决的问题时。

如果遇到新的需求和问题，需要引入新技术解决，也应选择与公司主流技术相近的技术。以大数据为例，如果公司的主流开发语言是Java，那么选择Hadoop体系的解决方案，学习曲线相比更平滑，部署和维护时也会更加方便。因为有丰富的Java系统运维经验，所以运维Hadoop会比运维其他平台更加得心应手。

可以查看系统的代码，是否存在大量不同的实现语言；针对类似的需求，是否出现了不同的框架。如果有公司的内部框架，是否是基于该框架搭建的系统，还是使用了其他框架。

### 案例说明

以搭建一个Web应用为例，公司的主流应用都选择Spring MVC，那么在新建系统时，就应该首先考虑使用Java，并且选择Spring MVC作为基础。不要使用Struts，甚至是使用PHP来开发应用。选择统一的框架好处很多，比如在遇到框架问题时，可以统一修复，然后集中打补丁，如果框架不同，那么面对同一个问题就需要有多套解决方案。

既然大多数系统都是Java的，那么在运维方面会积累不少Java相关的经验，比如部署和调优，如果突然出现一个PHP的系统，那么Java方面的经验基本就无法奏效了，运维的人员不清楚该如何部署和优化PHP的系统。这会给生产环境带来不小的隐患。

## Rule 3. 系统需要具备垂直伸缩及水平伸缩的能力

### 目的描述

在系统容量到达瓶颈是，通常的做法无非是提升服务器的能力，或者是增加服务器的数量，但是有时由于系统本身的原因无法利用更好的硬件，或者没有办法部署到多台服务器上同时分担负载。为了更好地解决系统容量问题，改善稳定性，系统应该要具备能够垂直伸缩及水平伸缩的能力。

### 实践要点

垂直伸缩和水平伸缩是两个不同的方向，但都与系统的设计息息相关，同时也要注意实现时的一些细节问题。

#### 如何支持垂直伸缩

垂直伸缩，即提升单台服务器的性能，比如增加更多的CPU、内存和磁盘，这里我们着重讲讲CPU和内存。

CPU的提升可以是提升单核主频，也可以是增加更多的核数，前者能加快处理速度，提升响应时间，后者能增强并发处理能力。如果系统中存在大量锁或者是阻塞操作，那会严重影响系统的性能，即使提升主频，响应时间的提升可能和主频的提升不成正比。由于锁的存在，一些原本可以并发的地方会退化为串行执行。如果使用了线程池，线程池的配置过小，也会降低并发能力，即使核数再多也表现不佳。

增加内存，需要考虑操作系统的限制和应用本身的限制。比如，32位Linux下，一个进程的用户态内存最多只能3G；Java应用如果配置了-Xmx为2G，那么堆的最大可用内存也就限制在2G，即使服务器上有10G的内存也无法利用。

#### 如何支持水平伸缩

水平伸缩，即在集群中增加更多的服务器数量，以分担集群的负载。集群化的前提就是尽量做到无状态，没有状态以后请求就能落到任意的服务器上进行处理，而不用考虑状态的同步。其次，尽量拆分任务，将原本只能在一台服务器上处理的任务打散到多台服务器上并行处理。

随着并行度的提高，也会出现一些只有单机时不会遇到的问题。例如，不同服务器上重复捞取同一个任务执行；服务器的负载不均衡，有的服务器负载过重，而有的则没有压力等等。

### 案例说明

假设系统中配置了一个Spring的线程池Bean，coreSize与maxSize均为5，那么随着CPU核数的增加，与该线程池相关的任务处理能力并不会相应增加，需要调整线程池的大小，以适应新的硬件配置。本例旨在说明代码中的各种配置并不是一成不变的，随着环境的变化也需要进行相应的调整，相同的例子还有JVM的JAVA_OPTS配置、Apache的Worker配置等等。

另一个例子是定时任务，原本单机的定时任务可以通过Quartz实现，到了集群环境中，同样可以使用Quartz，但需要控制任务的并行执行，避免出现多台服务器捞取相同任务执行的情况。假设该任务原本是顺序检查100个系统的摘要计数，那么可以将顺序变为并行，充分发挥多核性能，到了集群环境中，可以更进一步，将一个任务，拆分为100个任务，每个任务是统计一个系统的摘要，这100个任务分发到集群中执行，可充分发挥集群的性能。

## Rule 4. 努力消除系统中的单点
## Rule 5. 为系统中的热点降温
## Rule 6. 保证操作的幂等性
## Rule 7. 系统间的交互尽量采用异步方式
