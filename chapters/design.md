# 设计篇

在建设一个网站时，其最初的设计往往会对整个系统起到至关重要的影响。因此，在众多不同方面之中，我们先来讨论下系统的一些设计规则，

本篇内容概括如下：

1. 避免复杂的方案和过度设计
2. 尽量使用统一的技术和框架
3. 系统需要具备垂直伸缩及水平伸缩的能力
4. 努力消除系统中的单点
5. 为系统中的热点降温
6. 保证操作的幂等性
7. 系统间的交互尽量采用异步方式

## Rule 1. 避免复杂的方案和过度设计

### 目的描述

避免出现过于复杂的系统设计和实现，尤其是看似超前的过度设计。

### 实践要点

任何系统中都应尽量避免复杂的设计，尤其是过度设计，不仅增加了工作量，还提升了开发和运维的难度，却没有带来相应的好处。

> 做的复杂不难，做的简单才难

在满足系统今后一段时间内的可扩展性和稳定性要求的同事，尽力那个避免复杂的架构和局部实现，以简单的方式直接实现需求。一个难以理解的方案，同样会难于实现和运维。

此外，不要为了虚无缥缈的目标进行设计，例如，原本要求为一家中型公司设计CRM和ERP，但是在具体设计方案时却按照2000万用户的级别来设计，这已经和上海市的人口在一个数量级上了，显然远远超出了实际需求。

在完成概要设计后，再找几位没有参与设计的同学，向他们叙述方案，如果对方不能很快理解设计方案，说明该方案过于复杂。如果设计的方案能够支持未来5-10年的需求，那也许可以考虑在实现上加以简化。

### 案例说明

以淘宝的某个中间件产品为例（[http://hellojava.info/?p=152](http://hellojava.info/?p=152)），为了实现应用中jar的隔离以及动态加载，选择了OSGi作为底层技术。虽然实现了隔离性，但是代价极大，从开发到部署都要做大量改动，事后作者感叹道：

>当年那个基础产品改造完后，确实享受到了和应用隔离带来的好处，动态化在生产环境也玩过下，确实挺爽，但付出的代价是极大的，并且要做到真正的完全动态是不行的，也就意味着动态化这特性基本就是个玩具，因此后来在回顾这次技术决定时，我一直都承认，这是我做的一个最技术的，最失败的决定，如果是可以重来，我会选择不用OSGi，而是自己做一个简单的classloader隔离机制。

再举个例子，假设一个电子商务网站，其中包含用户表users、产品表products、订单表orders，预计三张表的数据量三年后会增长到1000万、500万和1亿。那么是否有必要在一开始就引入大数据技术，用NoSQL，用HBase？也许这个网站根本就活不到三年，何苦为了这么久远，如此“伟大”的目标，而在前期投入巨大的人力物力呢？

最初的设计可以直接选择关系型数据库，比如MySQL，待数据发展到一定的规模后，垂直拆分成多个库；某张表的数据量继续发展一定规模后，再在拆分后的库里实施水平拆分，按照某个特定的规则将一张表拆分成10张，甚至100张。核心的原则就是把复杂的决策和功能留到实际需要的时候再做。

## Rule 2. 尽量使用统一的技术和框架

### 目的描述

在同一个公司内，如非必要，尽量采用统一的技术和框架，避免出现技术繁杂的情况，过多的异构系统会带来一定的运维成本，不同系统的运维方式不同，配置也不尽相同，突然引入的新技术可能对现有体系带来一定的冲击。

### 实践要点

在现有体系中如果需要新建系统，在技术选型时，可以考虑采用与现有系统相近的技术和框架；如果公司有成熟的内部框架，更应该首先考虑使用内部框架，原因是内部框架一般都会更加符合公司的情况，且遇到问题时能够得到更快速的响应。不要出于个人喜好选择不同的，甚至是另类的框架和技术，比如在一家以Java为主的公司里，在生产系统中使用Lisp就比较另类，尤其是在处理能用Java解决的问题时。

如果遇到新的需求和问题，需要引入新技术解决，也应选择与公司主流技术相近的技术。以大数据为例，如果公司的主流开发语言是Java，那么选择Hadoop体系的解决方案，学习曲线相比更平滑，部署和维护时也会更加方便。因为有丰富的Java系统运维经验，所以运维Hadoop会比运维其他平台更加得心应手。

可以查看系统的代码，是否存在大量不同的实现语言；针对类似的需求，是否出现了不同的框架。如果有公司的内部框架，是否是基于该框架搭建的系统，还是使用了其他框架。

### 案例说明

以搭建一个Web应用为例，公司的主流应用都选择Spring MVC，那么在新建系统时，就应该首先考虑使用Java，并且选择Spring MVC作为基础。不要使用Struts，甚至是使用PHP来开发应用。选择统一的框架好处很多，比如在遇到框架问题时，可以统一修复，然后集中打补丁，如果框架不同，那么面对同一个问题就需要有多套解决方案。

既然大多数系统都是Java的，那么在运维方面会积累不少Java相关的经验，比如部署和调优，如果突然出现一个PHP的系统，那么Java方面的经验基本就无法奏效了，运维的人员不清楚该如何部署和优化PHP的系统。这会给生产环境带来不小的隐患。

## Rule 3. 系统需要具备垂直伸缩及水平伸缩的能力

### 目的描述

在系统容量到达瓶颈是，通常的做法无非是提升服务器的能力，或者是增加服务器的数量，但是有时由于系统本身的原因无法利用更好的硬件，或者没有办法部署到多台服务器上同时分担负载。为了更好地解决系统容量问题，改善稳定性，系统应该要具备能够垂直伸缩及水平伸缩的能力。

### 实践要点

垂直伸缩和水平伸缩是两个不同的方向，但都与系统的设计息息相关，同时也要注意实现时的一些细节问题。

#### 如何支持垂直伸缩

垂直伸缩，即提升单台服务器的性能，比如增加更多的CPU、内存和磁盘，这里我们着重讲讲CPU和内存。

CPU的提升可以是提升单核主频，也可以是增加更多的核数，前者能加快处理速度，提升响应时间，后者能增强并发处理能力。如果系统中存在大量锁或者是阻塞操作，那会严重影响系统的性能，即使提升主频，响应时间的提升可能和主频的提升不成正比。由于锁的存在，一些原本可以并发的地方会退化为串行执行。如果使用了线程池，线程池的配置过小，也会降低并发能力，即使核数再多也表现不佳。

增加内存，需要考虑操作系统的限制和应用本身的限制。比如，32位Linux下，一个进程的用户态内存最多只能3G；Java应用如果配置了-Xmx为2G，那么堆的最大可用内存也就限制在2G，即使服务器上有10G的内存也无法利用。

#### 如何支持水平伸缩

水平伸缩，即在集群中增加更多的服务器数量，以分担集群的负载。集群化的前提就是尽量做到 **无状态** ，没有状态以后请求就能落到任意的服务器上进行处理，而不用考虑状态的同步。其次，尽量拆分任务，将原本只能在一台服务器上处理的任务打散到多台服务器上并行处理。

随着并行度的提高，也会出现一些只有单机时不会遇到的问题。例如，不同服务器上重复捞取同一个任务执行；服务器的负载不均衡，有的服务器负载过重，而有的则没有压力等等。

为了让系统能够水平伸缩，可以采取很多手段，比如：

1. 让每次请求都是无状态的（如果无法避免“状态”的问题，可以考虑在安全的情况下，使用分布式缓存或Cookies来共享状态）
2. 将单个大应用按照一定维度拆分为多个小应用
3. 将串行执行的步骤改为并行执行
4. 将同步调用改为异步调用

### 案例说明

假设系统中配置了一个Spring的线程池Bean，coreSize与maxSize均为5，那么随着CPU核数的增加，与该线程池相关的任务处理能力并不会相应增加，需要调整线程池的大小，以适应新的硬件配置。本例旨在说明：

>代码中的各种配置并不是一成不变的，随着环境的变化也需要进行相应的调整

相同的例子还有JVM的JAVA_OPTS配置、Apache的Worker配置等等。

另一个例子是定时任务，原本单机的定时任务可以通过Quartz实现，到了集群环境中，同样可以使用Quartz，但需要控制任务的并行执行，避免出现多台服务器捞取相同任务执行的情况。假设该任务原本是顺序检查100个系统的摘要计数，那么可以将顺序变为并行，充分发挥多核性能，到了集群环境中，可以更进一步，将一个任务，拆分为100个任务，每个任务是统计一个系统的摘要，这100个任务分发到集群中执行，可充分发挥集群的性能。

## Rule 4. 努力消除系统中的单点

### 目的描述

一般的系统都会进行集群部署，或者准备热备，以防止单台服务器故障或者系统宕机影响业务的正常运行。如果系统中存在只能单机部署（或运行）的情况，那么应该尽快消除该单点。

### 实践要点

要消除单点，首先必须找到单点。一个系统中的单点可以出现在任何地方，比如数据库、缓存这样的基础设施，也可以是应用系统本身，系统依赖的某个外部第三方服务，甚至是某个硬件。

数据库已经有了比较成熟的解决方案，例如两台数据库之间进行主从复制，从库作为热备，亦或者是双活配置的两个库。memcached和redis之类的分布式缓存本身不支持集群，但是可以通过客户端来“曲线救国”，对缓存的键进行一致性哈希，结果放到不同的服务器上，损失一台服务器不至于丢失所有的内容。大多数的基础设施都有一定的集群化能力，不应该成为单点。

如果是系统本身无法运行在一台以上的服务器上，那么就要分析具体原因，对症下药，努力将其拆分成集群。第三方服务由于不受控制，只能选择在故障时降级，不调用该服务，如果无法规避，则选择快速失败的策略，避免拖死整个系统。

**如果实在无法消除单点，那至少应该考虑单点故障时的应急措施或者是降级手段。**

### 案例说明

不少网站都会需要发送短信，一般的短信发送都是通过ISV或者某地运营商提供的通道发送的。如果一家网站只接入了浙江移动一家服务商，当浙江移动通道发生问题时，就意味着该网站的短信彻底瘫痪，这就是一个单点。优化的方法就是引入多家短信服务商，分摊短信发送量，当一个渠道异常时，能够快速关闭该渠道，由其他渠道消化故障渠道的短信任务。

很多大型系统在基础设施中都会搭建服务的注册中心，用来管理各个子系统发布的服务，以及服务的订阅关系，以此实现两服务器间的点对点调用。比如，A系统发布了A.1服务，B系统引用了A.1服务，注册中心会将所有发布了A.1服务的服务器列表推送给B系统。由于注册中心的特殊性，所有系统均会依赖它，但注册中心又无法轻易集群化。一旦注册中心发生异常，可能造成调用方取不到发布方服务器列表，无法正常调用，此时可以将“软负载”的方式降级为“硬负载”，即为每个系统的集群再额外配置一个由F5、Nginx或LVS实现的集群负载均衡地址，将调用目标从具体的单台服务器降级为调用集群地址。

## Rule 5. 为系统中的热点降温

### 目的描述
当一个系统中存在频繁访问或修改的“热点”时，即使集群有充足的容量应对当前的请求量，但仍有可能表现不稳定，甚至发生错误和宕机。应该及时发现系统中的“热点”，并及时采取措施避免其带来恶劣的影响。

### 实践要点
要为热点降温，首先就要找到系统中的热点。

1. 设计时或配置时就预先识别一些可能存在的热点，比如中间账户、促销商户账户、全局计数器、网站首页、默认用户Logo图片等等。
2. 出现热点时，要能快速找到热点，比如通过日志文件发现热点，在Apache、Nginx的访问日志中查找短时间内频繁访问的目标，在数据库日志中查找频繁操作的记录等等。

找到热点后，就是如何去消除热点，或者是如何让热点不会影响系统的正常运行。如上所述，**常见的热点可能会是网站上的某个页面、图片，数据库中的某几条记录。**

针对不同的热点，会有不同的处理办法：

- 针对页面，可以考虑动态页面静态化，成为静态页面后就可方便的进行缓存或放入CDN。
- 针对图片，除了同页面那样进行缓存和CDN，还可以调整图片格式或压缩比例。
- 针对数据库中的记录，读数据库相对简单，设置合理的缓存及失效策略即可；写数据则相对复杂，首先考虑降低锁的粒度，避免不必要的锁争用，其次，考虑将多个操作进行合并执行。

### 案例说明
以用户头像为例，一般网站都会提供默认的用户头像，大量未设置自定义头像的用户都会使用该头像文件。在大量用户访问页面时，每次刷新页面都会访问该文件，因此，默认头像图片即为系统中的一个热点。如果该文件未被缓存，那所有请求将直接落到图片服务器上，文件被加载到内存中的情况还好，如果每次都读取磁盘那后果可想而知。

可以考虑针对此类静态图片设置缓存，由缓存服务器来响应请求，一次访问后，直接让浏览器取本地缓存。更好的办法是将热点图片直接分发到CDN上，由CDN来承担这部分流量，一来可以降低源服务器的压力和服务器的网络流量，二来可以提供更好的用户体验，让用户访问离自己最近的节点。大部分静态资源热点都可以使用类似的方法。

然后再来看看热点记录，比如计数器，一篇热门文章，需要显示点击次数，如果每次访问都操作数据库记录，计数加一，那么势必会对性能有所影响，访问量越大，访问速度就越慢。可以考虑在服务器上先对计数累加，比如每累计100次才更新一次数据库，其代价就是显示的点击数字不够精确。

>针对一些疑难杂症，业务上的优化或者让步往往比一味追求技术上的解决方案更加行之有效，当然，前提是业务上能够允许这么做。

## Rule 6. 保证操作的幂等性

### 目的描述

### 实践要点

### 案例说明

## Rule 7. 系统间的交互尽量采用异步方式
